<!doctype html>
<html class="no-js" lang="">
  <head>
    <style>
      * {
        margin: 0;
      }
      body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";

      }
      .wrap {
        background-color: pink;
        font-weight: bold;
        text-align: center;
        line-height: 40px;
      }
    </style>
  </head>
  <body>
    <div id="app">
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get('username');

      var app = new Vue({
        el: '#app',
        template: '<div class="wrap">{{ this.loading ? `Loading ${this.username}...` : `Record: ${this.wins} - ${this.losses}` }}</div>',
        data: {
          //start: new Date(),
          start: new Date("2020-04-30T22:15:13.155Z"),
          username: username,
          wins: 0,
          losses: 0,
          userId: undefined,
          loading: true,
          updateRecord () {
            this.wins = this.wins + 1;
          },
        },
        methods: {
          async getUserId () {
            var userId = (await (await fetch(`https://valorant.iesdev.com/player/${username}`)).json()).id;
            this.userId = userId;
            this.loading = false;
            this.getUpdates()
            setTimeout(this.getUpdates, 4000);
          },
          async getUpdates() {
            var matches = (await (await fetch(`https://valorant.iesdev.com/matches/${this.userId}`)).json()).data;
            var sinceStart = matches.filter((match)=>new Date(match.startedAt) >= this.start);

            const getUserTeam = (match) => {
              for (player of match.players) {
                if (player.subject === this.userId){
                  return player.teamId;
                }
              }
            };

            let wins = sinceStart.map((match)=> {
              var team1 = match.teams[0];
              var team2 = match.teams[1];
              var team = getUserTeam(match);
              if (team1.won && team1.teamId === team) {
                return `${team1.roundsWon} - ${team2.roundsWon}`
              }
              else if (team2.won && team2.teamId === team) {
                return `${team2.roundsWon} - ${team1.roundsWon}`
              }
            });

            this.wins = sinceStart.reduce((acc, match)=> {
              var team1 = match.teams[0];
              var team2 = match.teams[1];
              var userTeam = getUserTeam(match);

              if (team1.won && team1.teamId === userTeam) 
                return acc + 1;
              else if (team2.won && team2.teamId === userTeam) 
                return acc + 1;
              else 
                return acc;

            }, 0);
            this.losses = sinceStart.length - this.wins;

            console.log(wins);
          },
        },
        created () {
          this.getUserId();
        }
      })
    </script>
  </body>
</html>
