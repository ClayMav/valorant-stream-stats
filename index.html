<!doctype html>
<html class="no-js" lang="">
  <head>
    <style>
      * {
        margin: 0;
      }
      body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";

      }
      .wrap {
        background-color: pink;
        font-weight: bold;
        text-align: center;
        line-height: 40px;
      }
    </style>
  </head>
  <body>
    <div id="app">
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
      function UsernameException() {}

      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get('username');

      var app = new Vue({
        el: '#app',
        template: '<div class="wrap">{{ this.loading ? `Loading ${this.username}...` : (this.error ? `Error: ${this.error}` : `Record: ${this.wins} - ${this.losses}`) }}</div>',
        data: {
          start: new Date("2020-07-03T03:50:39.423Z"),
          username: username,
          wins: 0,
          losses: 0,
          userId: undefined,
          loading: true,
          error: undefined,
        },
        methods: {
          async getUserId () {
            try {
              var playerRequest = await fetch(`https://valorant.iesdev.com/player/${username}`);
              if (!playerRequest.ok) {
                throw new UsernameException();
              }

              var userId = (await playerRequest.json()).id;
            }
            catch (e) {
                this.error = `Add "?username=<blitz.gg username>`;
                return;
            }

            this.userId = userId;
            this.loading = false;
          },
          async getUpdates() {
            console.log("Fetching updates...")
            var matches = (await (await fetch(`https://valorant.iesdev.com/matches/${this.userId}`)).json()).data;
            var sinceStart = matches.filter((match)=>new Date(match.startedAt) >= this.start);

            const getUserTeam = (match) => {
              for (player of match.players) {
                if (player.subject === this.userId){
                  return player.teamId;
                }
              }
            };

            console.log("MATCHES", matches)
            console.log("SINCE_START", sinceStart)

            let wins = sinceStart.map((match)=> {
              var team1 = match.teams[0];
              var team2 = match.teams[1];
              var team = getUserTeam(match);
              if (team1.won && team1.teamId === team) {
                return `${team1.roundsWon} - ${team2.roundsWon}`
              }
              else if (team2.won && team2.teamId === team) {
                return `${team2.roundsWon} - ${team1.roundsWon}`
              }
            });

            this.wins = sinceStart.reduce((acc, match)=> {
              var team1 = match.teams[0];
              var team2 = match.teams[1];
              var userTeam = getUserTeam(match);

              if (team1.won && team1.teamId === userTeam) 
                return acc + 1;
              else if (team2.won && team2.teamId === userTeam) 
                return acc + 1;
              else 
                return acc;

            }, 0);
            this.losses = sinceStart.length - this.wins;
          },
        },
        async created () {
          await this.getUserId();

          this.getUpdates()
          window.setInterval(this.getUpdates, 4000);
        }
      })
    </script>
  </body>
</html>
