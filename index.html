<!doctype html>
<html class="no-js" lang="">
  <head>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";

      }
      .wrap {
        font-weight: bold;
        text-align: center;
        line-height: 20px;
      }
    </style>
  </head>
  <body>
    <div id="app">
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
      function UsernameException() {}
      const RANKS = ["Unrated", "", "Iron I", "Iron II", "Iron III", "Bronze I", "Bronze II", "Bronze III", "Silver I", "Silver II", "Silver III", "Gold I", "Gold II", "Gold III", "Platinum I", "Platinum II", "Platinum III", "Diamond I", "Diamond II", "Diamond III", "Immortal I", "Immortal II", "Immortal III", "Radiant", ]

      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get('username');
      const bg = urlParams.get('bg');
      const color = urlParams.get('color');
      const winOffset = urlParams.get('winOffset');
      const lossOffset = urlParams.get('lossOffset');

      var app = new Vue({
        el: '#app',
        template: '<div class="wrap"><div>{{ this.loading ? `Loading ${this.username}...` : (this.error ? `Error: ${this.error}` : `Record: ${this.wins}W - ${this.losses}L`) }}</div><div>Rank: {{ this.rank }}</div></div></div>',
        data: {
          start: new Date(),
          username: username,
          winOffset: isNaN(parseInt(winOffset)) ? 0 : parseInt(winOffset),
          lossOffset: isNaN(parseInt(lossOffset)) ? 0 : parseInt(lossOffset),
          wins: 0,
          losses: 0,
          rank: "unknown",
          userId: undefined,
          loading: true,
          error: undefined,
        },
        methods: {
          async getUserId () {
            try {
              var playerRequest = await fetch(`https://valorant.iesdev.com/player/${username}`);
              if (!playerRequest.ok) {
                throw new UsernameException();
              }

              var user = await playerRequest.json();
            }
            catch (e) {
                this.error = `Add "?username=<blitz.gg username>`;
                return;
            }

            this.userId = user.id;
            this.rank = RANKS[user.ranks.competitive.tier - 1];
            this.loading = false;
          },
          async getUpdates() {
            console.log("Fetching updates...")
            var matches = (await (await fetch(`https://valorant.iesdev.com/matches/${this.userId}`)).json()).data;
            var sinceStart = matches.filter((match)=>new Date(match.startedAt) >= this.start);

            const getUserTeam = (match) => {
              for (player of match.players) {
                if (player.subject === this.userId){
                  return player.teamId;
                }
              }
            };

            wins = sinceStart.reduce((acc, match)=> {
              var team1 = match.teams[0];
              var team2 = match.teams[1];
              var userTeam = getUserTeam(match);

              if (team1.won && team1.teamId === userTeam) 
                return acc + 1;
              else if (team2.won && team2.teamId === userTeam) 
                return acc + 1;
              else 
                return acc;

            }, 0);
            losses = sinceStart.length - this.wins;

            this.wins = this.winOffset + wins;
            this.losses = this.lossOffset + losses;
          },
        },
        async created () {
          await this.getUserId();

          this.getUpdates()
          window.setInterval(this.getUpdates, 4000);
        }
      })
    </script>
  </body>
</html>
