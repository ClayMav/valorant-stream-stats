<!doctype html>
<html class="no-js" lang="">
  <head>
    <style>
      * {
        margin: 0;
        padding: 0;
      }
      body {
          font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol";
      }
      .wrap {
        font-weight: bold;
        text-align: center;
        line-height: 20px;
      }
    </style>
  </head>
  <body>
    <div id="app">
    </div>
    <script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
    <script>
      function UsernameException() {}
      const RANKS = ["Unrated", "", "Iron I", "Iron II", "Iron III", "Bronze I", "Bronze II", "Bronze III", "Silver I", "Silver II", "Silver III", "Gold I", "Gold II", "Gold III", "Platinum I", "Platinum II", "Platinum III", "Diamond I", "Diamond II", "Diamond III", "Immortal I", "Immortal II", "Immortal III", "Radiant", ]

      const urlParams = new URLSearchParams(window.location.search);
      const username = urlParams.get('username');
      const bg = urlParams.get('bg');
      const color = urlParams.get('color');
      const winOffset = urlParams.get('winOffset');
      const lossOffset = urlParams.get('lossOffset');

      var app = new Vue({
        el: '#app',
        template: '<div class="wrap"><div v-if="this.loading">Loading {{this.username}}...</div><div v-if="this.error">Error: {{this.error}}</div><div v-else><div>Record: {{this.wins}}W - {{this.losses}}L</div><div>Rank: {{this.rank}}</div></div></div>',
        data: {
          start: new Date(),
          username: username,
          winOffset: isNaN(parseInt(winOffset)) ? 0 : parseInt(winOffset),
          lossOffset: isNaN(parseInt(lossOffset)) ? 0 : parseInt(lossOffset),
          wins: 0,
          losses: 0,
          rank: "unknown",
          userId: undefined,
          loading: true,
          error: undefined,
        },
        methods: {
          async getUserId () {
            let user;
            try {
              if (!this.username) {
                throw new UsernameException();
              }
              const playerRequest = await fetch(`https://valorant.iesdev.com/player/${username}`);
              if (!playerRequest.ok) {
                throw new UsernameException();
              }

              user = await playerRequest.json();
            }
            catch (e) {
              if (!this.username) {
                this.error = `Add "?username=<blitz.gg username>" to the url`;
              } else {
                this.error = `Check that username is accurate in url`;
              }

              this.loading = false;
              return;
            }

            // on successful profile get
            this.loading = false;
            this.userId = user.id;
            this.rank = RANKS[user.ranks.competitive.tier - 1];
          },
          getUserTeam(match) {
              for (player of match.players) {
                if (player.subject === this.userId){
                  return player.teamId;
                }
              }
          },
          async getUpdates() {
            console.log("Fetching updates...")
            let matchesJson;

            try {
              if (!this.userId) {
                throw new UsernameException();
              }

              const matchesUri = `https://valorant.iesdev.com/matches/${this.userId}`
              const matchesRequest = await fetch(matchesUri);
              if (!matchesRequest.ok) {
                throw new UsernameException();
              }

              matchesJson = await matchesRequest.json();
            }
            catch (e) {
              if (!this.username) {
                this.error = `Add "?username=<blitz.gg username>" to the url`;
              } else {
                this.error = `Check that username is accurate in url`;
              }
                this.loading = false;
                return;
            }

            const matches = matchesJson.data;
            const sinceStart = matches.filter((match)=>new Date(match.startedAt) >= this.start);

            wins = sinceStart.reduce((acc, match)=> {
              const team1 = match.teams[0];
              const team2 = match.teams[1];
              const userTeam = this.getUserTeam(match);

              if (team1.won && team1.teamId === userTeam) 
                return acc + 1;
              else if (team2.won && team2.teamId === userTeam) 
                return acc + 1;
              else 
                return acc;

            }, 0);
            losses = sinceStart.length - this.wins;

            this.wins = this.winOffset + wins;
            this.losses = this.lossOffset + losses;
          },
        },
        async created () {
          await this.getUserId();

          this.getUpdates()
          window.setInterval(this.getUpdates, 4000);
        }
      })
    </script>
  </body>
</html>
